import React, { createContext, useContext, useState, useEffect } from 'react';
import { MOCK_COURSES } from '../data/mockData';

const CourseContext = createContext();

export const CourseProvider = ({ children }) => {
    const [courses, setCourses] = useState([]);
    const [enrolledMap, setEnrolledMap] = useState({}); // userId -> [courseId]
    const [enrollmentMetaMap, setEnrollmentMetaMap] = useState({}); // userId -> { courseId: { registeredAt } }
    const [progressMap, setProgressMap] = useState({}); // userId -> { courseId: [moduleId] }
    const COURSE_SEED_VERSION = '2026-02-fullstack-v1';
    const ENROLLMENT_SEED_VERSION = '2026-02-fullstack-v1';

    const normalizeCourseProgress = (userCourseProgress) => {
        if (Array.isArray(userCourseProgress)) {
            return {
                completedModules: userCourseProgress,
                assignmentSubmitted: false,
                assignmentFileName: '',
                assignmentFileType: '',
                assignmentFileDataUrl: '',
                assignmentScore: null
            };
        }

        return {
            completedModules: userCourseProgress?.completedModules || [],
            assignmentSubmitted: !!userCourseProgress?.assignmentSubmitted,
            assignmentFileName: userCourseProgress?.assignmentFileName || '',
            assignmentFileType: userCourseProgress?.assignmentFileType || '',
            assignmentFileDataUrl: userCourseProgress?.assignmentFileDataUrl || '',
            assignmentScore: typeof userCourseProgress?.assignmentScore === 'number'
                ? userCourseProgress.assignmentScore
                : null
        };
    };

    const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;

    const toSafeDate = (value) => {
        const date = new Date(value);
        return Number.isNaN(date.getTime()) ? null : date;
    };

    const getDefaultRegistrationDate = (offsetDays = 0) => {
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        now.setDate(now.getDate() - offsetDays);
        return now.toISOString();
    };

    const buildEnrollmentMetaFromMap = (enrollmentMap) => {
        return Object.entries(enrollmentMap || {}).reduce((acc, [userId, courseIds]) => {
            const userMeta = {};

            courseIds.forEach((courseId, index) => {
                userMeta[courseId] = {
                    registeredAt: getDefaultRegistrationDate(index)
                };
            });

            acc[userId] = userMeta;
            return acc;
        }, {});
    };

    useEffect(() => {
        // Initialize courses
        const storedCourses = localStorage.getItem('courses');
        const storedCourseSeedVersion = localStorage.getItem('coursesSeedVersion');
        if (storedCourses && storedCourseSeedVersion === COURSE_SEED_VERSION) {
            setCourses(JSON.parse(storedCourses));
        } else {
            setCourses(MOCK_COURSES);
            localStorage.setItem('courses', JSON.stringify(MOCK_COURSES));
            localStorage.setItem('coursesSeedVersion', COURSE_SEED_VERSION);
        }

        // Initialize enrollments
        const storedEnrollments = localStorage.getItem('enrollments');
        const storedEnrollmentSeedVersion = localStorage.getItem('enrollmentsSeedVersion');
        if (storedEnrollments && storedEnrollmentSeedVersion === ENROLLMENT_SEED_VERSION) {
            setEnrolledMap(JSON.parse(storedEnrollments));
        } else {
            // Seed default student enrollment
            const defaultEnrollments = { 'u2': ['c1', 'c2', 'c3'] };
            setEnrolledMap(defaultEnrollments);
            localStorage.setItem('enrollments', JSON.stringify(defaultEnrollments));
            localStorage.setItem('enrollmentsSeedVersion', ENROLLMENT_SEED_VERSION);
        }

        const storedEnrollmentMeta = localStorage.getItem('enrollmentMeta');
        if (storedEnrollmentMeta) {
            setEnrollmentMetaMap(JSON.parse(storedEnrollmentMeta));
        } else {
            const currentEnrollments = storedEnrollments && storedEnrollmentSeedVersion === ENROLLMENT_SEED_VERSION
                ? JSON.parse(storedEnrollments)
                : { 'u2': ['c1', 'c2', 'c3'] };

            const defaultEnrollmentMeta = buildEnrollmentMetaFromMap(currentEnrollments);
            setEnrollmentMetaMap(defaultEnrollmentMeta);
            localStorage.setItem('enrollmentMeta', JSON.stringify(defaultEnrollmentMeta));
        }

        const storedProgress = localStorage.getItem('courseProgress');
        if (storedProgress) {
            setProgressMap(JSON.parse(storedProgress));
        } else {
            setProgressMap({});
            localStorage.setItem('courseProgress', JSON.stringify({}));
        }
    }, []);

    const addCourse = (newCourse) => {
        const updatedCourses = [...courses, { ...newCourse, id: Date.now().toString() }];
        setCourses(updatedCourses);
        localStorage.setItem('courses', JSON.stringify(updatedCourses));
    };

    const updateCourse = (updatedCourse) => {
        const updatedCourses = courses.map(c => c.id === updatedCourse.id ? updatedCourse : c);
        setCourses(updatedCourses);
        localStorage.setItem('courses', JSON.stringify(updatedCourses));
    };

    const deleteCourse = (courseId) => {
        // Remove from courses
        const updatedCourses = courses.filter(c => c.id !== courseId);
        setCourses(updatedCourses);
        localStorage.setItem('courses', JSON.stringify(updatedCourses));

        // Remove from enrollments
        const newEnrolledMap = { ...enrolledMap };
        Object.keys(newEnrolledMap).forEach(userId => {
            newEnrolledMap[userId] = newEnrolledMap[userId].filter(id => id !== courseId);
        });
        setEnrolledMap(newEnrolledMap);
        localStorage.setItem('enrollments', JSON.stringify(newEnrolledMap));

        const updatedProgressMap = { ...progressMap };
        Object.keys(updatedProgressMap).forEach(userId => {
            if (updatedProgressMap[userId]?.[courseId]) {
                const userCourseProgress = { ...updatedProgressMap[userId] };
                delete userCourseProgress[courseId];
                updatedProgressMap[userId] = userCourseProgress;
            }
        });
        setProgressMap(updatedProgressMap);
        localStorage.setItem('courseProgress', JSON.stringify(updatedProgressMap));
    };

    const enroll = (userId, courseId) => {
        const userEnrollments = enrolledMap[userId] || [];
        if (!userEnrollments.includes(courseId)) {
            const updatedMap = {
                ...enrolledMap,
                [userId]: [...userEnrollments, courseId]
            };
            setEnrolledMap(updatedMap);
            localStorage.setItem('enrollments', JSON.stringify(updatedMap));

            const updatedEnrollmentMetaMap = {
                ...enrollmentMetaMap,
                [userId]: {
                    ...(enrollmentMetaMap[userId] || {}),
                    [courseId]: {
                        registeredAt: new Date().toISOString()
                    }
                }
            };
            setEnrollmentMetaMap(updatedEnrollmentMetaMap);
            localStorage.setItem('enrollmentMeta', JSON.stringify(updatedEnrollmentMetaMap));
        }
    };

    const unenroll = (userId, courseId) => {
        const userEnrollments = enrolledMap[userId] || [];
        if (userEnrollments.includes(courseId)) {
            const updatedMap = {
                ...enrolledMap,
                [userId]: userEnrollments.filter(id => id !== courseId)
            };
            setEnrolledMap(updatedMap);
            localStorage.setItem('enrollments', JSON.stringify(updatedMap));

            const userEnrollmentMeta = enrollmentMetaMap[userId] || {};
            if (userEnrollmentMeta[courseId]) {
                const updatedUserEnrollmentMeta = { ...userEnrollmentMeta };
                delete updatedUserEnrollmentMeta[courseId];

                const updatedEnrollmentMetaMap = {
                    ...enrollmentMetaMap,
                    [userId]: updatedUserEnrollmentMeta
                };

                setEnrollmentMetaMap(updatedEnrollmentMetaMap);
                localStorage.setItem('enrollmentMeta', JSON.stringify(updatedEnrollmentMetaMap));
            }

            const userProgress = progressMap[userId] || {};
            if (userProgress[courseId]) {
                const updatedUserProgress = { ...userProgress };
                delete updatedUserProgress[courseId];
                const updatedProgressMap = {
                    ...progressMap,
                    [userId]: updatedUserProgress
                };
                setProgressMap(updatedProgressMap);
                localStorage.setItem('courseProgress', JSON.stringify(updatedProgressMap));
            }
        }
    };

    const markModuleCompleted = (userId, courseId, moduleId) => {
        const userProgress = progressMap[userId] || {};
        const normalizedCourseProgress = normalizeCourseProgress(userProgress[courseId]);

        const completedModules = normalizedCourseProgress.completedModules || [];

        if (completedModules.includes(moduleId)) {
            return;
        }

        const updatedProgressMap = {
            ...progressMap,
            [userId]: {
                ...userProgress,
                [courseId]: {
                    ...normalizedCourseProgress,
                    completedModules: [...completedModules, moduleId]
                }
            }
        };

        setProgressMap(updatedProgressMap);
        localStorage.setItem('courseProgress', JSON.stringify(updatedProgressMap));
    };

    const markAssignmentSubmitted = (userId, courseId) => {
        const userProgress = progressMap[userId] || {};
        const normalizedCourseProgress = normalizeCourseProgress(userProgress[courseId]);

        if (normalizedCourseProgress.assignmentSubmitted) {
            return;
        }

        const updatedProgressMap = {
            ...progressMap,
            [userId]: {
                ...userProgress,
                [courseId]: {
                    ...normalizedCourseProgress,
                    assignmentSubmitted: true
                }
            }
        };

        setProgressMap(updatedProgressMap);
        localStorage.setItem('courseProgress', JSON.stringify(updatedProgressMap));
    };

    const submitAssignment = (userId, courseId, submissionFile) => {
        const userProgress = progressMap[userId] || {};
        const normalizedCourseProgress = normalizeCourseProgress(userProgress[courseId]);

        const submittedFileName = typeof submissionFile === 'string'
            ? submissionFile
            : submissionFile?.name || normalizedCourseProgress.assignmentFileName;
        const submittedFileType = typeof submissionFile === 'string'
            ? normalizedCourseProgress.assignmentFileType
            : submissionFile?.type || normalizedCourseProgress.assignmentFileType;
        const submittedFileDataUrl = typeof submissionFile === 'string'
            ? normalizedCourseProgress.assignmentFileDataUrl
            : submissionFile?.dataUrl || normalizedCourseProgress.assignmentFileDataUrl;

        const updatedProgressMap = {
            ...progressMap,
            [userId]: {
                ...userProgress,
                [courseId]: {
                    ...normalizedCourseProgress,
                    assignmentSubmitted: true,
                    assignmentFileName: submittedFileName,
                    assignmentFileType: submittedFileType,
                    assignmentFileDataUrl: submittedFileDataUrl,
                    assignmentScore: null
                }
            }
        };

        setProgressMap(updatedProgressMap);
        localStorage.setItem('courseProgress', JSON.stringify(updatedProgressMap));
    };

    const gradeAssignment = (studentId, courseId, score) => {
        const userProgress = progressMap[studentId] || {};
        const normalizedCourseProgress = normalizeCourseProgress(userProgress[courseId]);

        if (!normalizedCourseProgress.assignmentSubmitted) {
            return;
        }

        const boundedScore = Math.max(0, Math.min(25, Number(score) || 0));
        const updatedProgressMap = {
            ...progressMap,
            [studentId]: {
                ...userProgress,
                [courseId]: {
                    ...normalizedCourseProgress,
                    assignmentScore: boundedScore
                }
            }
        };

        setProgressMap(updatedProgressMap);
        localStorage.setItem('courseProgress', JSON.stringify(updatedProgressMap));
    };

    const getCompletedModules = (userId, courseId) => {
        const userCourseProgress = normalizeCourseProgress(progressMap[userId]?.[courseId]);
        return userCourseProgress.completedModules;
    };

    const isAssignmentSubmitted = (userId, courseId) => {
        const userCourseProgress = normalizeCourseProgress(progressMap[userId]?.[courseId]);
        return userCourseProgress.assignmentSubmitted;
    };

    const getAssignmentScore = (userId, courseId) => {
        const userCourseProgress = normalizeCourseProgress(progressMap[userId]?.[courseId]);
        return userCourseProgress.assignmentScore;
    };

    const isAssignmentGraded = (userId, courseId) => {
        const assignmentScore = getAssignmentScore(userId, courseId);
        return typeof assignmentScore === 'number';
    };

    const getAssignmentDetails = (userId, courseId) => {
        return normalizeCourseProgress(progressMap[userId]?.[courseId]);
    };

    const getCourseProgress = (userId, courseId, totalModules) => {
        const safeTotalModules = totalModules || 0;
        if (safeTotalModules === 0) {
            return getAssignmentScore(userId, courseId) || 0;
        }

        const modulesProgress = (getCompletedModules(userId, courseId).length / safeTotalModules) * 75;
        const assignmentProgress = getAssignmentScore(userId, courseId) || 0;

        return Math.min(100, Math.round(modulesProgress + assignmentProgress));
    };

    const hasCompletedCourseComponents = (userId, courseId, totalModules) => {
        const safeTotalModules = totalModules || 0;
        const modulesDone = getCompletedModules(userId, courseId).length >= safeTotalModules;
        return modulesDone && isAssignmentGraded(userId, courseId);
    };

    const isCoursePassed = (userId, courseId, totalModules) => {
        const progress = getCourseProgress(userId, courseId, totalModules);
        return hasCompletedCourseComponents(userId, courseId, totalModules) && progress >= 90;
    };

    const getEnrolledCourses = (userId) => {
        const ids = enrolledMap[userId] || [];
        return courses.filter(c => ids.includes(c.id));
    };

    const getCourseStudents = (courseId) => {
        return Object.keys(enrolledMap).filter(userId => enrolledMap[userId].includes(courseId));
    };

    const getEnrollmentDate = (userId, courseId) => {
        const registeredAt = enrollmentMetaMap[userId]?.[courseId]?.registeredAt;
        return toSafeDate(registeredAt) || new Date();
    };

    const getUpcomingTasks = (userId) => {
        const enrolledCourses = getEnrolledCourses(userId);

        return enrolledCourses
            .map((course, index) => {
                const registrationDate = getEnrollmentDate(userId, course.id);
                const dueDate = new Date(registrationDate.getTime() + ONE_WEEK_MS);

                return {
                    id: `${course.id}-assignment`,
                    courseId: course.id,
                    assignmentTitle: `Assignment ${index + 1}`,
                    courseTitle: course.title,
                    dueDate,
                    isSubmitted: isAssignmentSubmitted(userId, course.id)
                };
            })
            .filter(task => !task.isSubmitted)
            .sort((a, b) => a.dueDate.getTime() - b.dueDate.getTime());
    };

    const pruneInvalidEnrollments = (validUserIds) => {
        const validSet = new Set(validUserIds || []);
        let hasChanges = false;

        const cleanedMap = Object.entries(enrolledMap).reduce((acc, [userId, courseIds]) => {
            if (!validSet.has(userId)) {
                hasChanges = true;
                return acc;
            }

            acc[userId] = courseIds;
            return acc;
        }, {});

        if (hasChanges) {
            setEnrolledMap(cleanedMap);
            localStorage.setItem('enrollments', JSON.stringify(cleanedMap));

            const cleanedMetaMap = Object.entries(enrollmentMetaMap).reduce((acc, [userId, meta]) => {
                if (!validSet.has(userId)) {
                    return acc;
                }

                acc[userId] = meta;
                return acc;
            }, {});

            setEnrollmentMetaMap(cleanedMetaMap);
            localStorage.setItem('enrollmentMeta', JSON.stringify(cleanedMetaMap));
        }
    };

    return (
        <CourseContext.Provider value={{ courses, addCourse, updateCourse, deleteCourse, enroll, unenroll, getEnrolledCourses, getCourseStudents, pruneInvalidEnrollments, markModuleCompleted, markAssignmentSubmitted, submitAssignment, gradeAssignment, getCompletedModules, isAssignmentSubmitted, getAssignmentScore, isAssignmentGraded, getAssignmentDetails, getCourseProgress, hasCompletedCourseComponents, isCoursePassed, getEnrollmentDate, getUpcomingTasks }}>
            {children}
        </CourseContext.Provider>
    );
};

export const useCourses = () => useContext(CourseContext);
